# 메모리 누수

프로그램이 작동하며 할당됐던 메모리가 사용하지 않는 시점에서도 반환되지 않는 현상을 메모리 누수라고 합니다. **JavaScript에서의 메모리 누수**는 어떻게 일어나는지 알아보고 이를 해결하여 **성능을 최적화 하는 방법**에 대해서 배워보도록 하겠습니다.

<br />

## JS에서의 메모리 관리

JS는 가비지 컬렉트 언어 중 하나입니다. `가비지 컬렉터`는 이전에 할당한 메모리를 여전히 사용 중인지 `주기적으로 검사`하여 사용하지 않는 `메모리를 해제` 시키는 역할을 합니다. 따라서 개발자들이 메모리 관리에 신경을 덜 쓸 수 있도록 도와주는 것입니다. 그렇다면 가비지 컬렉트 언어인 JS에서는 메모리 누수가 왜 발생하게 되는 것일까요?

<br />

## JS에서의 메모리 누수

가비지 컬렉트 언어에서 메모리 누수의 주요 원인은 `예상치 못한 참조`입니다.

### 1. 우발적으로 선언된 전역 변수

- 함수 내부에서 사용할 변수를 키워드를 생략하여 선언한 경우, 변수는 전역적으로 생성됩니다.

```jsx
function foo() {
  bar = "accidental global variables";
}

// 코드 실행시 아래와 같이 동작

function foo() {
  window.bar = "accidental global variables";
}
```

- 전역 변수는 null로 처리하거나 재할당을 하지 않는 한 가비지 컬렉터에 수집되지 않습니다.
- 해결 방법: `use strict`를 추가하여 전역 객체 생성을 방지할 수 있습니다. → React에서도 strict mode를 사용하면 방지할 수 있습니다.

### 2. 잊혀진 타이머와 콜백 함수

```jsx
var data = getData();
setInterval(function () {
  var tag = document.getElementById("result");

  if (tag) {
    tag.innerHTML = data;
  }
}, 1000);
```

- setInterval 내부에서 외부 변수는 data를 참조하고 있습니다. 이를 사용하지 않을 때 제거해주지 않으면 매우 큰 데이터를 가지고 있을 수 있는 data 변수 또한 GC에 의하여 수집되지 않아 많은 메모리를 차지하게 될 가능성이 있습니다.
- 해결 방법: `removeEventListener`, `clearTimeout` 등으로 명시적으로 이벤트를 제거해줍니다.
  - 특정 브라우저 (Internet Explorer 6 등)은 이러한 observer 형태를 관리하지 못해서 이벤트를 제거해주는 것이 중요했습니다.
  - 최신 브라우저들은 사용되지 않는 경우에 메모리 누수가 발생하지 않도록 구현되어 있지만, 명시적으로 제거해주는 것이 좋은 관행입니다.

### 3. DOM 외부 참조

DOM 노드 자체를 `자료구조` 내에 저장하는 경우, DOM 요소를 제거하고자 할 경우 DOM 트리와 자료구조 `두 군데에서 모두 제거`해야합니다.

```jsx
var elemMap = {
  button: document.getElementById("button"),
  image: document.getElementById("image"),
  text: document.getElementById("text"),
};

function removeButton() {
  document.body.removeChild(document.getElementById("button"));
}
```

- removeButton이 실행된 경우 DOM에서는 button이 사라지지만 elemMap 자료구조에서 여전히 참조하고 있기 때문에, GC에 의해 수집되지 않고 메모리를 잡고 있게 됩니다.
- DOM 요소를 참조할 경우 삭제 되는 경우를 고려하여 사용하여야 합니다.

### 4. 클로저

- 클로저는 상위 스코프의 변수에 접근이 가능한 함수입니다.
- 하위 함수에서 상위 함수의 변수에 접근하고 있다면, `상위 함수의 변수`는 가비지 콜렉터에 의해 해제가 되지 않습니다. `직접 메모리 해제`를 시켜주어야 합니다.

<br />

## 요약

1. 자바스크립트는 가비지 컬렉트 언어입니다. 이 방식은, 할당한 메모리를 애플리케이션에서 여전히 사용중인지 검사해 메모리 관리에 대해서 개발자들이 덜 신경 쓰게 도와줍니다.
2. 자바스크립트에서의 메모리 누수 주요 원인은 '**예상치 못한 참조**'입니다.
3. 메모리 누수의 일반적인 형태는 아래와 같습니다.
   1. 우발적으로 생긴 전역변수
   2. 잊혀진 타이머와 콜백
   3. DOM을 외부에서 참조
   4. 클로저

<br />

## JS에서 성능을 최적화 하는 방법

면접에서 JS 환경에서의 성능 최적화 경험에 대한 질문을 받는다면 어떻게 대답하는게 좋을까요?

성능 최적화라는 개념이 어렵게 느껴질 수 있지만, 이 질문을 “웹 페이지가 멈추는 경우 어떻게 해결하면 좋을까?”라는 질문으로 풀어본다면 이전에 배웠던 **브라우저 최적화 방법**과 이번에 배운 **메모리 누수** 개념을 이용하여 충분히 대답할 수 있습니다.

> Q. 웹 페이지가 멈추는 경우 원인이 무엇일까요? 해결할 방법이 있을까요?

A.

1. **네트워크 요청이 너무 많아서 데이터 전송 속도가 느려지는 경우**
   - 캐싱으로 최적화
2. **특정 리소스의 번들이 매우 큰 경우**
   - 해당 번들을 분할
3. **많은 리플로우와 리페인트 발생**
   - reflow가 일어나지 않는 속성 사용합니다. 예를 들어 display:none 사용이 있습니다.
4. **메모리 누수**
   - 앞서 배웠던 4가지 원인을 제거합니다.
     - 우발적으로 생긴 전역변수
     - 잊혀진 타이머와 콜백
     - DOM을 외부에서 참조
     - 클로저
